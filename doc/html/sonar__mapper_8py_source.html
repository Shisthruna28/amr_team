<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>amr_mapping: sonar_mapper.py Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_adab8ea82f17a26c489f963116bd2a39.html">catkin_ws</a></li><li class="navelem"><a class="el" href="dir_e51d568f37d638e58d18f2832cd5207c.html">src</a></li><li class="navelem"><a class="el" href="dir_36099cb11eb0dce9b18bf30b2e716703.html">team5</a></li><li class="navelem"><a class="el" href="dir_6eaf68f3cdb7b83ba1bb5785ffe31320.html">amr_mapping</a></li><li class="navelem"><a class="el" href="dir_e417da209ca5d18ae922c3c16d3f0143.html">nodes</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">sonar_mapper.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="sonar__mapper_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="namespacesonar__mapper.html">    1</a></span>&#160;<span class="comment">#!/usr/bin/env python</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno"><a class="line" href="namespacesonar__mapper.html#a6bfe87955b3b71058c3aeacad077b05e">    3</a></span>&#160;PACKAGE = <span class="stringliteral">&#39;amr_mapping&#39;</span></div>
<div class="line"><a name="l00004"></a><span class="lineno"><a class="line" href="namespacesonar__mapper.html#a3426a3e8bf22c9797938efe5b002969a">    4</a></span>&#160;NODE = <span class="stringliteral">&#39;sonar_mapper&#39;</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">import</span> rospy</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">import</span> tf</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">from</span> amr_srvs.srv <span class="keyword">import</span> SwitchRanger, SwitchRangerRequest</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">from</span> amr_msgs.msg <span class="keyword">import</span> Ranges</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">from</span> nav_msgs.msg <span class="keyword">import</span> MapMetaData, OccupancyGrid</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">from</span> <a class="code" href="namespaceamr__mapping_1_1sonar__map.html">amr_mapping.sonar_map</a> <span class="keyword">import</span> SonarMap</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html">   15</a></span>&#160;<span class="keyword">class </span><a class="code" href="classsonar__mapper_1_1SonarMapperNode.html">SonarMapperNode</a>:</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="stringliteral">    This is a port of the AMR C++ SonarMapperNode</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    </div>
<div class="line"><a name="l00020"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#aa2d33a8fc169a7b5c0997a4345e0c74b">   20</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#aa2d33a8fc169a7b5c0997a4345e0c74b">__init__</a>(self):</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;        </div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;        rospy.init_node(NODE)</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;        </div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;        <span class="comment"># Wait until SwitchRanger service (and hence stage node) becomes available:</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;        rospy.loginfo(<span class="stringliteral">&#39;Waiting for the /switch_ranger service to be advertised...&#39;</span>)</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;        switch_ranger_client = rospy.ServiceProxy(<span class="stringliteral">&#39;/switch_ranger&#39;</span>, SwitchRanger)</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;        switch_ranger_client.wait_for_service()</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;        </div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;        <span class="comment"># Make sure that the braitenberg sonars are available and enable them.</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        srr = SwitchRangerRequest()</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        srr.name = <span class="stringliteral">&#39;sonar_pioneer&#39;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;        srr.state = <span class="keyword">True</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        </div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;        <span class="keywordflow">if</span> switch_ranger_client.call(srr):</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;            rospy.loginfo(<span class="stringliteral">&#39;Enabled pioneer sonars.&#39;</span>)</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;            rospy.logerr(<span class="stringliteral">&#39;Pioneer sonars are not available, shutting down.&#39;</span>)</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;            exit()</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;        </div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;        </div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="stringliteral">            Parameters</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#a7c102901ff5c4e3dbe1e3ef14832da51">   44</a></span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a7c102901ff5c4e3dbe1e3ef14832da51">_frame_id</a> = rospy.get_param(<span class="stringliteral">&#39;frame_id&#39;</span>, <span class="stringliteral">&#39;odom&#39;</span>)</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        resolution = rospy.get_param(<span class="stringliteral">&#39;sonar_mapper/resolution&#39;</span>, 0.06)</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;        size_x = rospy.get_param(<span class="stringliteral">&#39;sonar_mapper/size_x&#39;</span>, 16.0)</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        size_y = rospy.get_param(<span class="stringliteral">&#39;sonar_mapper/size_y&#39;</span>, 16.0)</div>
<div class="line"><a name="l00048"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#a32190728fb029a52f323f633d2a0d8d7">   48</a></span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a32190728fb029a52f323f633d2a0d8d7">_map_publication_period</a> = rospy.get_param(<span class="stringliteral">&#39;sonar_mapper/map_publication_period&#39;</span>, 5.0)</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        </div>
<div class="line"><a name="l00050"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#aad7a43b7923cc2eeb80e935dfb360321">   50</a></span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#aad7a43b7923cc2eeb80e935dfb360321">_map</a> = <a class="code" href="classamr__mapping_1_1sonar__map_1_1SonarMap.html">SonarMap</a>(resolution, size_x, size_y)</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        </div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;        </div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="stringliteral">            Publishers</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#a026f0b6ff96e569c62981cd9725369b1">   56</a></span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a026f0b6ff96e569c62981cd9725369b1">_map_publisher</a> = rospy.Publisher(<span class="stringliteral">&#39;sonar_mapper/map&#39;</span>,</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;                                              OccupancyGrid,</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;                                              queue_size=1)</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#a0fbf5d2f0f659cac39bd5bc7d0deb590">   59</a></span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a0fbf5d2f0f659cac39bd5bc7d0deb590">_map_free_publisher</a> = rospy.Publisher(<span class="stringliteral">&#39;sonar_mapper/map_free&#39;</span>,</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;                                                   OccupancyGrid,</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;                                                   queue_size=1)</div>
<div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#a96b741810206a2808e5d86f955224525">   62</a></span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a96b741810206a2808e5d86f955224525">_map_occupied_publisher</a> = rospy.Publisher(<span class="stringliteral">&#39;sonar_mapper/map_occupied&#39;</span>,</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;                                                       OccupancyGrid,</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;                                                       queue_size=5)</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        </div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="stringliteral">            Subscribers</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#a0891792e899fc66fff730750fe6b122c">   69</a></span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a0891792e899fc66fff730750fe6b122c">_sonar_subscriber</a> = rospy.Subscriber(<span class="stringliteral">&#39;/sonar_pioneer&#39;</span>,</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                                                  Ranges,</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;                                                  self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a4db8bc3afd864a527cd60b293236e0d7">_sonar_callback</a>,</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;                                                  queue_size=5)</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        </div>
<div class="line"><a name="l00074"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#aaf7f72b8469270f7886df881ec804b85">   74</a></span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#aaf7f72b8469270f7886df881ec804b85">_tf</a>= tf.TransformListener()</div>
<div class="line"><a name="l00075"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#a6355db15646da97289a900cda8fd2279">   75</a></span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a6355db15646da97289a900cda8fd2279">_last_map_publication</a> = rospy.Time.now()</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        rospy.loginfo(<span class="stringliteral">&#39;Started [sonar_mapper] node.&#39;</span>)</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a7d4ed4c62433edfee00fc117b47d3254">_publish_maps</a>(<span class="keyword">True</span>)</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    </div>
<div class="line"><a name="l00080"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#a4db8bc3afd864a527cd60b293236e0d7">   80</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a4db8bc3afd864a527cd60b293236e0d7">_sonar_callback</a>(self, msg):</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        count = 0</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        <span class="keywordflow">for</span> r <span class="keywordflow">in</span> msg.ranges:</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            count += 1</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                time = self._tf.getLatestCommonTime(self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a7c102901ff5c4e3dbe1e3ef14832da51">_frame_id</a>,</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                                                    r.header.frame_id)</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                position, quaternion = self._tf.lookupTransform(self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a7c102901ff5c4e3dbe1e3ef14832da51">_frame_id</a>,</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                                                                r.header.frame_id,</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                                                                [r.header.stamp-rospy.Duration(0.01), time][time&lt;r.header.stamp])</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            <span class="keywordflow">except</span> Exception <span class="keyword">as</span> ex:</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                rospy.logwarn(<span class="stringliteral">&#39;Unable to incorporate sonar reading in the map &#39;</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                              <span class="stringliteral">&#39;Reason: {}.&#39;</span>.format(ex.message))</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                <span class="keywordflow">continue</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            <span class="comment">#Incorporate range reading in the map:</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;            self._map.add_scan(position[0],</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                               position[1],</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                               tf.transformations.euler_from_quaternion(quaternion)[2],</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;                               r.field_of_view,</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;                               r.max_range,</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                               r.range,</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                               self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a3f16d079972d3095ed8500b0b59a0ad8">_calculate_range_uncertainty</a>(r.range, r.max_range))</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a7d4ed4c62433edfee00fc117b47d3254">_publish_maps</a>()</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    </div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    </div>
<div class="line"><a name="l00105"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#a7d4ed4c62433edfee00fc117b47d3254">  105</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a7d4ed4c62433edfee00fc117b47d3254">_publish_maps</a>(self, force = False):</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        <span class="keywordflow">if</span> force <span class="keywordflow">or</span> self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a6355db15646da97289a900cda8fd2279">_last_map_publication</a> + rospy.Duration(self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a32190728fb029a52f323f633d2a0d8d7">_map_publication_period</a>)&lt;= rospy.Time.now():</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            w, h = self._map.get_grid_size_x(), self._map.get_grid_size_y()</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            min_x, min_y = self._map.get_min_x(), self._map.get_min_y()</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            resolution = self._map.get_resolution()</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            self._map_publisher.publish(self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#aef741ea6fc5fc97271f4782ade9b3973">_create_occupancy_grid_message</a>(</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                                        w, h, resolution, min_x, min_y, -1.0, 1.0,</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                                        self._map.get_map_data()))</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;            self._map_free_publisher.publish(self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#aef741ea6fc5fc97271f4782ade9b3973">_create_occupancy_grid_message</a>(</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                                        w, h, resolution, min_x, min_y, 0.0, 1.0,</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                                        self._map.get_map_free_data()))</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            self._map_occupied_publisher.publish(self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#aef741ea6fc5fc97271f4782ade9b3973">_create_occupancy_grid_message</a>(</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                                        w, h, resolution, min_x, min_y, 0.0, 1.0,</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                                        self._map.get_map_occupied_data()))</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a6355db15646da97289a900cda8fd2279">_last_map_publication</a> = rospy.Time.now()</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    </div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="keyword">def </span><a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#aef741ea6fc5fc97271f4782ade9b3973">_create_occupancy_grid_message</a>(self, width, height,</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                                       resolution,</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                                       orig_x, orig_y,</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                                       min_val, max_val,</div>
<div class="line"><a name="l00126"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#aef741ea6fc5fc97271f4782ade9b3973">  126</a></span>&#160;                                       data):</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        EPSILON = 1e-5</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        grid_msg = OccupancyGrid()</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        grid_msg.info.width = width</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        grid_msg.info.height = height</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        grid_msg.info.resolution = resolution</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        grid_msg.info.map_load_time = rospy.Time.now()</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        grid_msg.header.stamp = rospy.Time.now()</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        grid_msg.header.frame_id = self.<a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a7c102901ff5c4e3dbe1e3ef14832da51">_frame_id</a></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        grid_msg.info.origin.position.x = orig_x</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        grid_msg.info.origin.position.y = orig_y</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        grid_msg.data = data</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        </div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        <span class="keywordflow">return</span> grid_msg</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    </div>
<div class="line"><a name="l00142"></a><span class="lineno"><a class="line" href="classsonar__mapper_1_1SonarMapperNode.html#a3f16d079972d3095ed8500b0b59a0ad8">  142</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classsonar__mapper_1_1SonarMapperNode.html#a3f16d079972d3095ed8500b0b59a0ad8">_calculate_range_uncertainty</a>(self, registered_range, max_range):</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keywordflow">if</span> registered_range&lt;0.1*max_range:</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;            <span class="keywordflow">return</span> 0.01*max_range</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keywordflow">elif</span> registered_range&lt;0.5*max_range:</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;            <span class="keywordflow">return</span> 0.1*registered_range</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;            <span class="keywordflow">return</span> 0.05*max_range</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div>
<div class="line"><a name="l00152"></a><span class="lineno"><a class="line" href="namespacesonar__mapper.html#a7c60dd13acb95934b76fc150ddcac725">  152</a></span>&#160;    n = <a class="code" href="classsonar__mapper_1_1SonarMapperNode.html">SonarMapperNode</a>()</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    rospy.spin()</div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_aaf7f72b8469270f7886df881ec804b85"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#aaf7f72b8469270f7886df881ec804b85">sonar_mapper.SonarMapperNode._tf</a></div><div class="ttdeci">_tf</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00074">sonar_mapper.py:74</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_aa2d33a8fc169a7b5c0997a4345e0c74b"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#aa2d33a8fc169a7b5c0997a4345e0c74b">sonar_mapper.SonarMapperNode.__init__</a></div><div class="ttdeci">def __init__</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00020">sonar_mapper.py:20</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_a3f16d079972d3095ed8500b0b59a0ad8"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#a3f16d079972d3095ed8500b0b59a0ad8">sonar_mapper.SonarMapperNode._calculate_range_uncertainty</a></div><div class="ttdeci">def _calculate_range_uncertainty</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00142">sonar_mapper.py:142</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_a0fbf5d2f0f659cac39bd5bc7d0deb590"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#a0fbf5d2f0f659cac39bd5bc7d0deb590">sonar_mapper.SonarMapperNode._map_free_publisher</a></div><div class="ttdeci">_map_free_publisher</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00059">sonar_mapper.py:59</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_a0891792e899fc66fff730750fe6b122c"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#a0891792e899fc66fff730750fe6b122c">sonar_mapper.SonarMapperNode._sonar_subscriber</a></div><div class="ttdeci">_sonar_subscriber</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00069">sonar_mapper.py:69</a></div></div>
<div class="ttc" id="namespaceamr__mapping_1_1sonar__map_html"><div class="ttname"><a href="namespaceamr__mapping_1_1sonar__map.html">amr_mapping.sonar_map</a></div><div class="ttdef"><b>Definition:</b> <a href="sonar__map_8py_source.html#l00001">sonar_map.py:1</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_aef741ea6fc5fc97271f4782ade9b3973"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#aef741ea6fc5fc97271f4782ade9b3973">sonar_mapper.SonarMapperNode._create_occupancy_grid_message</a></div><div class="ttdeci">def _create_occupancy_grid_message</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00126">sonar_mapper.py:126</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_a6355db15646da97289a900cda8fd2279"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#a6355db15646da97289a900cda8fd2279">sonar_mapper.SonarMapperNode._last_map_publication</a></div><div class="ttdeci">_last_map_publication</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00075">sonar_mapper.py:75</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_a32190728fb029a52f323f633d2a0d8d7"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#a32190728fb029a52f323f633d2a0d8d7">sonar_mapper.SonarMapperNode._map_publication_period</a></div><div class="ttdeci">_map_publication_period</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00048">sonar_mapper.py:48</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_a4db8bc3afd864a527cd60b293236e0d7"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#a4db8bc3afd864a527cd60b293236e0d7">sonar_mapper.SonarMapperNode._sonar_callback</a></div><div class="ttdeci">def _sonar_callback</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00080">sonar_mapper.py:80</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_aad7a43b7923cc2eeb80e935dfb360321"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#aad7a43b7923cc2eeb80e935dfb360321">sonar_mapper.SonarMapperNode._map</a></div><div class="ttdeci">_map</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00050">sonar_mapper.py:50</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html">sonar_mapper.SonarMapperNode</a></div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00015">sonar_mapper.py:15</a></div></div>
<div class="ttc" id="classamr__mapping_1_1sonar__map_1_1SonarMap_html"><div class="ttname"><a href="classamr__mapping_1_1sonar__map_1_1SonarMap.html">amr_mapping.sonar_map.SonarMap</a></div><div class="ttdef"><b>Definition:</b> <a href="sonar__map_8py_source.html#l00014">sonar_map.py:14</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_a96b741810206a2808e5d86f955224525"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#a96b741810206a2808e5d86f955224525">sonar_mapper.SonarMapperNode._map_occupied_publisher</a></div><div class="ttdeci">_map_occupied_publisher</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00062">sonar_mapper.py:62</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_a7c102901ff5c4e3dbe1e3ef14832da51"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#a7c102901ff5c4e3dbe1e3ef14832da51">sonar_mapper.SonarMapperNode._frame_id</a></div><div class="ttdeci">_frame_id</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00044">sonar_mapper.py:44</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_a026f0b6ff96e569c62981cd9725369b1"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#a026f0b6ff96e569c62981cd9725369b1">sonar_mapper.SonarMapperNode._map_publisher</a></div><div class="ttdeci">_map_publisher</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00056">sonar_mapper.py:56</a></div></div>
<div class="ttc" id="classsonar__mapper_1_1SonarMapperNode_html_a7d4ed4c62433edfee00fc117b47d3254"><div class="ttname"><a href="classsonar__mapper_1_1SonarMapperNode.html#a7d4ed4c62433edfee00fc117b47d3254">sonar_mapper.SonarMapperNode._publish_maps</a></div><div class="ttdeci">def _publish_maps</div><div class="ttdef"><b>Definition:</b> <a href="sonar__mapper_8py_source.html#l00105">sonar_mapper.py:105</a></div></div>
</div><!-- fragment --></div><!-- contents -->

<br clear="all" />
<hr size="1"><div style="align: right;">
<a href="http://wiki.ros.org/amr_mapping">amr_mapping</a><br />
Author(s): Alexander Hagg</br />
<small>autogenerated on Wed Jan 10 2018 19:20:51</small>
</div>
</body>
</html>
